/*1366664812,173213213*/

if (self.CavalryLogger) { CavalryLogger.start_js(["+h1d2"]); }

__d("ImageUtils",["UserAgent"],function(a,b,c,d,e,f){var g=b('UserAgent'),h={hasLoaded:function(i){if(i.naturalWidth!==undefined){return i.complete&&i.width!==0;}else if(i.height==20&&i.width==20&&i.complete){return false;}else if(i.complete===undefined&&g.webkit()<500){var j=new Image();j.src=i.src;return j.complete;}return i.complete;}};e.exports=h;});
__d("PhotoEverstoreLogger",["Event","AsyncRequest","copyProperties","ImageUtils"],function(a,b,c,d,e,f){var g=b('Event'),h=b('AsyncRequest'),i=b('copyProperties'),j=b('ImageUtils'),k={BATCH_WINDOW_MS:500,storedLog:[]};function l(){}i(l,{_log:function(n){k.storedLog.push(n);if(k.storedLog.length==1)setTimeout(m,k.BATCH_WINDOW_MS,false);},logImmediately:function(n){l._log(n);},registerForLogging:function(n){if(j.hasLoaded(n)){l._log(n.src);}else g.listen(n,'load',function(event){l._log(n.src);});}});function m(){var n=k.storedLog;k.storedLog=[];var o=JSON.stringify(n);new h().setURI('/ajax/photos/logging/everstore_logging.php').setData({loggedUrls:o}).setMethod('POST').setOption('suppressErrorHandlerWarning',true).setOption('suppressErrorAlerts',true).send();}e.exports=l;});
__d("PhotoSessionLog",["AsyncRequest","Run","Vector","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('Run'),i=b('Vector'),j=b('copyProperties');function k(){}j(k,{UNKNOWN:0,ESC:1,X:2,OUTSIDE:3,UNLOAD:4,NAVIGATE:5,AGGREGATE:6,LEAVE:7,PERMALINK:0,SNOWLIFT:6,AGGREGATION_COUNT:20,set:null,time:null,views:0,fbidList:[],details:{},width:0,height:0,first:false,last:false,logIds:false,version:null,buttonLikes:0,pagingAction:'',faceTagImpressions:0,cycle:false,endOfRelevant:false,relevantCount:0,initLogging:function(l){this.set=null;this.time=new Date();this.views=0;this.hiResLoads=0;this.fullScreenViews={};this.first=true;this.last=false;this.logIds=false;this.version=l;this.buttonLikes=0;this.pagingAction='';this.faceTagImpressions=0;this.cycle=false;this.endOfRelevant=false;this.relevantCount=0;if(l===k.SNOWLIFT){var m=i.getViewportDimensions();this.width=m.x;this.height=m.y;}},setLogFbids:function(l){this.logIds=l;},setPhotoSet:function(l){this.set=l;},addButtonLike:function(){this.buttonLikes++;},setPagingAction:function(l){this.pagingAction=l;},addFaceTagImpression:function(){this.faceTagImpressions++;},setCycle:function(l){this.cycle=l;},setEndOfRelevant:function(l){this.endOfRelevant=l;},setRelevantCount:function(l){this.relevantCount=l;},setEndMetrics:function(l){this.endMetrics=l;},addPhotoView:function(l,m,n){if(this.logIds&&this.views>=this.AGGREGATION_COUNT)this.logPhotoViews(this.AGGREGATE);this.views++;if(l)this.fbidList.push([l.fbid,l.owner,Date.now()]);if(m)this.hiResLoads++;if(n)this.fullScreenViews[l.fbid]=true;},logEnterFullScreen:function(l){this.fullScreenViews[l]=true;},addDetailData:function(l,m){if(!this.details[l])this.details[l]={t:m.num_tags,l:m.has_location,c:m.has_caption,cm:m.comment_count,lk:m.like_count,w:m.width,h:m.height,ad:'{}',p:this.pagingAction};},updateAdData:function(l,m){if(this.details[l])this.details[l].ad=JSON.stringify(m);},logPhotoViews:function(l){if((!this.views)||(this.version===k.SNOWLIFT&&l==k.LEAVE))return;if(l!=this.AGGREGATE)this.last=true;var m={set:this.set,time:new Date()-this.time,fbids:this.logIds?this.fbidList:[],details:this.logIds?this.details:{},first:this.first,last:this.last,close:l?l:this.UNKNOWN,button_likes:this.buttonLikes,version:this.version,face_imp:this.faceTagImpressions,endmetric:this.endMetrics,cycle:this.cycle,end_relev:this.endOfRelevant,relev_count:this.relevantCount};if(this.version===k.SNOWLIFT){var n=i.getViewportDimensions();m.width=n.x||this.width;m.height=n.y||this.height;if(this.hiResLoads>0)m.hires_loads=this.hiResLoads;if(this.last){var o=Object.keys(this.fullScreenViews).length;if(o>0)m.fullscreen=o;}}new g().setURI('/ajax/photos/logging/session_logging.php').setAllowCrossPageTransition(true).setOption('asynchronous',(l!=k.UNLOAD)).setOption('suppressErrorHandlerWarning',true).setData(m).send();this.views=0;this.hiResLoads=0;this.fbidList=[];this.details={};this.first=false;this.buttonLikes=0;if(this.last){this.set=null;this.logIds=false;this.fullScreenViews={};}}});h.onUnload(function(){k.logPhotoViews(k.UNLOAD);});h.onLeave(function(){k.logPhotoViews(k.LEAVE);});e.exports=k;});
__d("PhotoViewerImage",["PhotoEverstoreLogger","URI","Vector","copyProperties"],function(a,b,c,d,e,f){var g=b('PhotoEverstoreLogger'),h=b('URI'),i=b('Vector'),j=b('copyProperties');function k(l){this._hiResDimensions=l.hiResDimensions&&i.deserialize(l.hiResDimensions);this._normalDimensions=l.normalDimensions&&i.deserialize(l.normalDimensions);this._info=l.info;this._video=l.video;this._shouldLog=l.everstoreLogThis;this._hiResSrc=l.hiResSrc;this._normalSrc=l.normalSrc;this._thumbSrc=l.thumbSrc;}j(k.prototype,{getURIString:function(){return h(this._info.permalink).getUnqualifiedURI().toString();},hasHiResDimensions:function(){return !!this._hiResDimensions;},getHiResDimensions:function(){return this._hiResDimensions;},getNormalDimensions:function(){return this._normalDimensions;},getHiResSrc:function(){return this._hiResSrc;},getNormalSrc:function(){return this._normalSrc;},getThumbSrc:function(){return this._thumbSrc;},getInfo:function(){return this._info;},getPermalink:function(){return this._info.permalink;},getHighestResSrc:function(){return this._hiResSrc||this._normalSrc;},preload:function(l){if(this.getHighestResSrc())if(l&&!this._resource){this._resource=new Image();this._resource.src=this.getHighestResSrc();if(this._shouldLog)g.logImmediately(this._resource.src);}else if(!l&&!this._small){this._small=new Image();this._small.src=this._normalSrc||this._hiResSrc;if(this._shouldLog)g.logImmediately(this._small.src);}}});e.exports=k;});
__d("PhotosConst",[],function(a,b,c,d,e,f){var g={VIEWER_PERMALINK:0,VIEWER_SNOWLIFT:6,VIEWER_VAULTBOX:8,BULK_EDITOR:3,FLASH_UPLOADER:4,HTML5_UPLOADER:10,SIZE_NORMAL:'n',PIC_NORMAL_FBX_SIZE:180};e.exports=g;});
__d("PhotosUtils",["copyProperties","Vector"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('Vector');function i(){}g(i,{getNearestBox:function(j,k){var l=Infinity,m=null;for(var n in j){var o=j[n];if(o.contains(k)){var p=k.distanceTo(o.getCenter());if(p<l){l=p;m=n;}}}return m;},absoluteToNormalizedPosition:function(j,k){var l=h.getElementPosition(j),m=h.getElementDimensions(j),n=k.sub(l).mul(100/m.x,100/m.y);n.domain='pure';return n;},normalizedToAbsolutePosition:function(j,k){var l=h.getElementPosition(j),m=h.getElementDimensions(j),n=k.mul(m.x/100,m.y/100).add(l);n.domain='document';return n;},isFacebox:function(j){return j.match(/^face:/);}});e.exports=i;});
__d("PhotoStreamCache",["HTML","PhotosConst","PhotoEverstoreLogger","PhotoViewerImage","Rect","UIPagelet","URI","Vector","copyProperties","createArrayFrom"],function(a,b,c,d,e,f){var g=b('HTML'),h=b('PhotosConst'),i=b('PhotoEverstoreLogger'),j=b('PhotoViewerImage'),k=b('Rect'),l=b('UIPagelet'),m=b('URI'),n=b('Vector'),o=b('copyProperties'),p=b('createArrayFrom');function q(){}o(q,{ERROR:'error',HTML:'html',IMAGE_DATA:'image',EXTRA:'extra',BUFFER_SIZE:3,INIT_BUCKET_SIZE:4,FULL_BUCKET_SIZE:12,ERROR_ID:-1,INIT_PLACEHOLDER:1});o(q.prototype,{init:function(r,s){this.version=r;this.pageletName=s;this.bufferSize=q.BUFFER_SIZE;this.fullBucketSize=q.FULL_BUCKET_SIZE;this.initError=false;this.isActive=true;this.leftLock=false;this.rightLock=false;this.useAjaxPipe=true;this.reset();},setUseAjaxPipe:function(r){this.useAjaxPipe=r;},reset:function(){this.cache={image:{},extra:{},html:{}};this.fbidList=[];this.loaded=false;this.allLoaded=false;this.permalinkMap={};this.position=0;this.totalCount=null;this.firstCursor=null;this.firstCursorIndex=null;},waitForInitData:function(){this.fbidList.push(q.INIT_PLACEHOLDER);},destroy:function(){this.reset();this.isActive=false;},isLoaded:function(){return this.loaded;},canPage:function(){if(!this.isLoaded())return false;if(this.totalCount!==null)return this.totalCount>1;return this.getLength()>1;},errorInCurrent:function(){if(this.initError){return true;}else if(!this.isLoaded())return false;return this.checkErrorAt(this.getCursor());},getLength:function(){return this.fbidList.length;},getPhotoSet:function(){return this.photoSetQuery.set;},getPhotoSetQuery:function(){return this.photoSetQuery;},getCurrentImageData:function(){return this.getImageData(this.getCursor());},getImageData:function(r){return this.getCacheContent(r,q.IMAGE_DATA);},getCurrentHtml:function(){return this.getCacheContent(this.getCursor(),q.HTML);},getCurrentExtraData:function(){return this.getCacheContent(this.getCursor(),q.EXTRA);},getCacheContent:function(r,s){if(!r||r===q.ERROR_ID||r===q.INIT_PLACEHOLDER)return null;return this.cache[s][r];},getCursorPos:function(){return this.position;},getCursor:function(){if(this.position>=0&&this.position<this.getLength())return this.fbidList[this.position];return null;},getCursorForURI:function(r){return this.permalinkMap[r];},calculatePositionForMovement:function(r){var s=this.position+r;if(this.allLoaded){var t=this.getLength();s=(t+s%t)%t;}return s;},isValidMovement:function(r){if(!this.isLoaded()||!this.canPage())return false;var s=this.calculatePositionForMovement(r);return this.getCursor()>0||(s>=0&&s<this.getLength());},moveCursor:function(r){if(!this.isValidMovement(r))return;this.position=this.calculatePositionForMovement(r);if(r!==0)this.loadMoreIfNeccessary(r>0);},checkErrorAt:function(r){if(!this.isLoaded())return false;if(r===q.ERROR_ID)return true;return false;},getRelativeMovement:function(r){for(var s=0;s<this.getLength();s++)if(this.fbidList[s]==r)return s-this.position;return null;},preloadImages:function(r){var s,t,u=this.getLength(),v=this.cache.image,w=q.BUFFER_SIZE;if(u>w*2){s=(this.position+u-w%u)%u;t=(this.position+w)%u;}else{s=0;t=u-1;}while(s!=t){var x=this.fbidList[s];if(this.version===h.VIEWER_VAULTBOX){v[x]&&v[x].preload(r);}else if(v[x]&&v[x].url)if(r&&!v[x].resource){v[x].resource=new Image();v[x].resource.src=v[x].url;if(v[x].everstoreLogThis===true)i.logImmediately(v[x].resource.src);}else if(!r&&!v[x].small){v[x].small=new Image();v[x].small.src=v[x].smallurl||v[x].url;if(v[x].everstoreLogThis===true)i.logImmediately(v[x].small.src);}s=(s+1)%u;}},loadMoreIfNeccessary:function(r){if(this.allLoaded||(r&&this.rightLock)||(!r&&this.leftLock))return;var s=r?1:-1,t=this.position+this.bufferSize*s;if(t<0&&!this.checkErrorAt(this.getEndCursor(false))){this.leftLock=true;this.fetch(this.fullBucketSize,false);}else if(t>this.getLength()&&!this.checkErrorAt(this.getEndCursor(true))){this.rightLock=true;this.fetch(this.fullBucketSize,true);}},getEndCursor:function(r){return r?this.fbidList[this.getLength()-1]:this.fbidList[0];},calculateRelativeIndex:function(r,s,t){if(!this.totalCount)return null;var u=this.fbidList.indexOf(s),v=this.fbidList.indexOf(t);if(u===-1||v===-1)return null;var w=v-u;return (r+w+this.totalCount)%this.totalCount;},calculateDistance:function(r,s){var t=this.fbidList.indexOf(r),u=this.fbidList.indexOf(s);if(t===-1||u===-1)return null;return (u-t+this.getLength())%this.getLength();},fetch:function(r,s){var t=this.getEndCursor(s),u=o({cursor:t,version:this.version,end:this.getEndCursor(!s),fetchSize:s?r:-1*r,relevant_count:this.relevantCount},this.photoSetQuery);if(this.totalCount&&this.firstCursorIndex!==null){u.total=this.totalCount;u.cursorIndex=this.calculateRelativeIndex(this.firstCursorIndex,this.firstCursor,t);}l.loadFromEndpoint(this.pageletName,null,u,{usePipe:this.useAjaxPipe,jsNonblock:true,crossPage:true});if(!this.useAjaxPipe)this.setUseAjaxPipe(true);},storeToCache:function(r){var s={};if(!this.isActive)return s;if('error' in r){this.processErrorResult(r.error);s.error=true;return s;}if('init' in r){this.processInitResult(r.init);s.init={logids:r.init.logids,fbid:r.init.fbid,loggedin:r.init.loggedin,fromad:r.init.fromad,disablesessionads:r.init.disablesessionads,flashtags:r.init.flashtags};}if('image' in r){this.processImageResult(r.image);s.image=true;}if('data' in r){this.processDataResult(r.data);s.data=true;}return s;},processInitResult:function(r){if(this.loaded)return;this.loaded=true;this.photoSetQuery=r.query;if(r.bufferSize)this.bufferSize=r.bufferSize;if(r.fullBucketSize)this.fullBucketSize=r.fullBucketSize;if(this.fbidList.length===0){this.fbidList.push(r.fbid);this.rightLock=true;}else{var s=this.fbidList.indexOf(q.INIT_PLACEHOLDER);if(s!=-1)this.fbidList[s]=r.fbid;}this.firstCursor=r.fbid;if('initIndex' in r&&'totalCount' in r){this.firstCursorIndex=r.initIndex;this.totalCount=r.totalCount;}if(this.version==h.VIEWER_PERMALINK)this.fetch(q.INIT_BUCKET_SIZE,true);},processImageResult:function(r){for(var s in r){if(s===this.firstCursor&&r[s].everstoreLogThis)i.logImmediately(r[s].url);if(this.version===h.VIEWER_VAULTBOX){var t=r[s];this.cache.image[s]=new j(t);this.permalinkMap[this.cache.image[s].getURIString()]=s;}else{this.cache.image[s]=r[s];if(r[s].dimensions)this.cache.image[s].dimensions=n.deserialize(r[s].dimensions);if(r[s].smalldims)this.cache.image[s].smalldims=n.deserialize(r[s].smalldims);this.permalinkMap[m(r[s].info.permalink).getUnqualifiedURI().toString()]=s;}}},attachToFbidsList:function(r,s,t){if(this.allLoaded)return;if(s===-1){for(var u=r.length-1;u>=0;u--){this.fbidList.unshift(r[u]);this.position++;}this.leftLock=false;}else{for(var v=0;v<r.length;v++)this.fbidList.push(r[v]);this.rightLock=false;}if(t)this.setAllLoaded();},setAllLoaded:function(){this.allLoaded=true;if(this.getCursor()===null)this.position=this.calculatePositionForMovement(0);},processDataResult:function(r){for(var s in r){if(!this.cache.html[s])this.cache.html[s]={};for(var t in r[s].html){var u=r[s].html[t];if(typeof u==='string')u=g(u).getRootNode();this.cache.html[s][t]=p(u.childNodes);}if(!('extra' in r[s])){this.cache.extra[s]=null;continue;}this.cache.extra[s]={tagRects:{}};if(!Array.isArray(r[s].extra.tagRects))for(var v in r[s].extra.tagRects)if(r[s].extra.tagRects[v])this.cache.extra[s].tagRects[v]=k.deserialize(r[s].extra.tagRects[v]);Object.keys(r[s].extra).forEach(function(w){if(w=='tagRects')return;this.cache.extra[s][w]=r[s].extra[w];}.bind(this));}},processErrorResult:function(r){if(!this.isLoaded()){this.initError=true;return;}var s=r.side,t=[q.ERROR_ID];this.attachToFbidsList(t,s);},setTotalCount:function(r){this.totalCount=r;},setFirstCursorIndex:function(r){this.firstCursorIndex=r;}});e.exports=q;});
__d("PhotoSnowliftAds",["Event","copyProperties","CSS","csx","DataStore","DOM","PhotoSessionLog","UIPagelet","URI","Vector"],function(a,b,c,d,e,f){var g=b('Event'),h=b('copyProperties'),i=b('CSS'),j=b('csx'),k=b('DataStore'),l=b('DOM'),m=b('PhotoSessionLog'),n=b('UIPagelet'),o=b('URI'),p=b('Vector'),q={DEFAULT_UNITS_REFRESH_RATE:30000,UNITS_REGISTER_DELAY:1000,root:null,availableDimensions:null,loadQuery:null,lastLoadTime:0,minAds:100,units:null,isLogAdData:null,refreshUnitsRate:null,adsStatus:'null',adsEvents:{},resetEvents:function(){this.adsStatus='reset';this.adsEvents={};},addEvent:function(r,s){if(s)this.adsStatus=r;var t=Date.now();this.adsEvents[r+'_'+t]=t;},init:function(r,s,t){this.reset();this.root=r;this.snowlift=s;this.minAds=t.min_ads;this.addEvent('init',true);this.refreshUnitsRate=q.DEFAULT_UNITS_REFRESH_RATE;if(t.refresh_fast)this.refreshUnitsRate=t.refresh_rate;},reset:function(){this.lastLoadTime=0;this.units=[];this.resetEvents();this.addEvent('reset',true);},resize:function(r){this.availableDimensions=r;this.loadQuery=this.snowlift.getLoadQuery();this.processResize();},calculateUnitSizes:function(r,s,t){var u={};r.forEach(function(v){var w=v.root.firstChild.offsetHeight;v.units.forEach(function(y){if(!i.hasClass(y,'hidden')&&!(this.getIsAds(y)&&this.getIsHoldout(y))){var z=this.getHeight(y.firstChild,s);w-=z;}}.bind(this));var x={height:w,visible:false};v.units.forEach(function(y){var z=this.getIsAds(y),aa=this.getHeight(y.firstChild,s),ba=this.getUnitId(y),ca=z&&this.getIsHoldout(y);if(ca&&t)return;u[ba]={height:aa,visible:false,priority:0,is_ads:z,is_holdout:ca,section_ref:x};}.bind(this));}.bind(this));return u;},calculateVisibleUnits:function(r,s,t){var u=0,v=this.getUnitPriority(s);v.forEach(function(w){if(s.hasOwnProperty(w)){var x=s[w],y=x.height;if(!x.section_ref.visible)y+=x.section_ref.height;x.height_below=t-y;x.visible=x.height_below>=0&&y>0;if(x.visible){x.section_ref.visible=true;t-=y;u++;}}}.bind(this));return s;},displayUnits:function(r,s){r.forEach(function(t){var u=false,v=true;t.units.forEach(function(w){var x=this.getUnitId(w),y=s[x];if(!y)return;var z=y.visible,aa=y.height_below,ba=y.is_ads;i.conditionClass(w,'hidden',!z);if(ba&&z&&v){var ca=l.find(w,'div.ego_unit');i.addClass(ca,'ego_unit_no_top_border');v=false;}u=u||z;this.calcUnitStats(this.units[ba][x],z,aa);}.bind(this));i.conditionClass(t.root,'hidden',!u);}.bind(this));},getUnitPriority:function(r){var s=[],t=0,u=0;for(var v in r){var w=r[v];s.push(v);var x=this.minAds+t+u;if(w.is_ads){if(u<this.minAds)x=u;u++;}else t++;w.priority=x;}s=s.sort(function(y,z){var aa=r[y],ba=r[z];return aa.priority-ba.priority;}.bind(this));return s;},updateUnitsStatus:function(){var r=this.availableDimensions.x,s=this.availableDimensions.y,t=this.calculateUnitSizes(this.sections,r);t=this.calculateVisibleUnits(this.sections,t,s);for(var u in t){if(!t.hasOwnProperty(u))continue;var v=t[u];if(!v.is_holdout||!v.visible)continue;var w=this.units[1][u];this.calcUnitStats(w,v.visible,v.height_below);}t=this.calculateUnitSizes(this.sections,r,true);t=this.calculateVisibleUnits(this.sections,t,s);this.displayUnits(this.sections,t);},calcUnitStats:function(r,s,t){var u=Date.now();if(r.visible)r.totalTime+=u-r.lastShowTime;if(r.trackingCode!==null&&r.totalTime>=this.UNITS_REGISTER_DELAY){var v=r.trackingCode;r.trackingCode=null;this.registerImpression(v,r.registerUrl);}r.visible=s;r.heightBelow=t;r.lastShowTime=u;},prepareResize:function(){var r=function(s){var t=l.create('div',{className:'inner'}),u=l.create('div',{className:'wrapper'},t);l.replace(s,u);l.setContent(t,s);return u;};this.sections=l.scry(this.root,'div.ego_section').map(function(s){return {root:r(s),units:l.scry(s,'div.ego_unit').map(r)};});},processResize:function(){if(this.isLoading||this.lastLoadTime===0||this.availableDimensions===null){this.setLogData();return;}this.updateUnitsStatus();this.setLogData();var r=this.nextRegisterTime();if(r!==Infinity)this.processResize.bind(this).defer(r,true);},setIsLogAdData:function(r){this.isLogAdData=r;this.addEvent('setIsLogAdData',false);this.setLogData();},setLogData:function(){var r=this.snowlift.getImageId();if(this.isLogAdData&&r){var s=p.getElementDimensions(this.snowlift.getImage()),t=p.getElementDimensions(this.snowlift.getRHCHeader()),u=p.getElementDimensions(this.snowlift.getRHCBody()),v=p.getElementDimensions(this.snowlift.getRHCFooter()),w={query_set:this.snowlift.getLoadQuery().set,window_x:window.innerWidth,window_y:window.innerHeight,image_x:s.x,image_y:s.y,header_x:t.x,header_y:t.y,body_x:u.x,body_y:u.y,footer_x:v.x,footer_y:v.y,ads_below_space:this.getAdsBelowSpace(),time:Date.now(),adsStatus:this.adsStatus,adsEvents:this.adsEvents};m.updateAdData(r,w);}},getAdsBelowSpace:function(){var r=[],s=this.units[1];for(var t in s)if(s.hasOwnProperty(t)&&!this.getIsHoldout(s[t]))r.push(s[t].heightBelow);return r;},getIsAds:function(r){var s=l.scry(r,"div._4u8");return s.length;},getUnitId:function(r){if(this.getIsAds(r)){return this.getAdId(r);}else return this.getEgoId(r);},getEgoId:function(r){var s=l.find(r,'div.ego_unit');return s.getAttribute('data-ego-fbid');},getAdData:function(r){var s=l.find(r,"div._4u8"),t=s.getAttribute('data-ad');return t&&JSON.parse(t)||{};},getAdId:function(r){return this.getAdData(r).adid;},getIsHoldout:function(r){return this.getAdData(r).holdout;},nextRegisterTime:function(){var r=Infinity,s=h(h({},this.units[0]),this.units[1]);for(var t in s)if(s.hasOwnProperty(t)){var u=s[t];if(u.trackingCode!==null&&u.visible)r=Math.min(r,this.UNITS_REGISTER_DELAY-u.totalTime);}return r;},getHeight:function(r,s){var t=k.get(r,'height');if(t&&t.x===s)return t.y;return this.cacheHeight(r,s);},cacheHeight:function(r,s){var t={x:s,y:r.offsetHeight};k.set(r,'height',t);return t.y;},loadAdsAndEgo:function(){this.resetEvents();this.addEvent('adsRequested',true);n.loadFromEndpoint('WebEgoPane',this.root,{pid:34,data:[this.loadQuery.set,true]},{crossPage:true,bundle:false});},unitsLoaded:function(r,s){var t;if(s){t='/ai.php';this.addEvent('adsLoaded',true);}else{t='/ajax/ei.php';this.addEvent('egoLoaded',true);}var u={};for(var v in r)if(r.hasOwnProperty(v))u[v]={trackingCode:r[v],totalTime:0,lastShowTime:0,heightBelow:-10000,visible:false,registerUrl:t};this.units[s]=u;if(s)this.waitForImages(this.imagesLoaded.bind(this));},imagesLoaded:function(){this.prepareResize();this.addEvent('imagesLoaded',true);this.lastLoadTime=Date.now();this.isLoading=false;this.processResize();i.removeClass(this.root,'loading');},loadAdsFromUserActivity:function(){var r=Date.now(),s=this.refreshUnitsRate;if(!this.isLoading&&r-this.lastLoadTime>s){i.addClass(this.root,'loading');this.isLoading=true;this.loadAdsAndEgo();}},registerImpression:function(r,s){var t=l.create('iframe',{src:o(s).addQueryData({aed:r}),width:0,height:0,frameborder:0,scrolling:'no',className:'fbEmuTracking'});t.setAttribute('aria-hidden','true');l.appendContent(this.root,t);},waitForImages:function(r){var s=l.scry(this.root,'img.img'),t=s.length,u=t;if(u===0)r();var v=function(){u--;if(u===0)r.defer();};for(var w=0;w<t;w++){var x=s[w];if(x.complete){v();}else g.listen(x,{load:v,error:v,abort:v});}}};e.exports=q;});
__d("PhotoViewer",["Bootloader","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('Bootloader'),h=b('copyProperties'),i=b('emptyFunction');function j(){this.image=null;this.root=null;this.stream=null;}h(j,{bootstrap:function(k,l){g.loadModules(['PhotoSnowlift'],function(m){m.bootstrap(k,l);});}});h(j.prototype,{getEventPrefix:i.thatReturnsNull,getEventString:function(k){var l=this.getEventPrefix();if(l)return l+'.'+k;return null;},getImage:function(){return this.image;},getPosition:function(){return this.stream?this.stream.getCursor():null;},getRoot:function(){return this.root;},getSourceString:i.thatReturnsNull,getVersionConst:i.thatReturnsNull});e.exports=j;});
__d("PhotoSnowlift",["function-extensions","Arbiter","AsyncDialog","AsyncRequest","Bootloader","Class","CSS","Dialog","DOM","DOMControl","Event","FullScreen","ImageUtils","Keys","LinkController","Locale","PageTransitions","Parent","PhotosConst","PhotoSessionLog","PhotoSnowliftAds","PhotoStreamCache","PhotosUtils","PhotoViewer","Rect","ScrollableArea","Style","Toggler","UIPagelet","URI","UserAgent","Vector","$","computeRelativeURI","copyProperties","createArrayFrom","csx","emptyFunction","ge","goURI","shield","tx","userAction"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('AsyncDialog'),i=b('AsyncRequest'),j=b('Bootloader'),k=b('Class'),l=b('CSS'),m=b('Dialog'),n=b('DOM'),o=b('DOMControl'),p=b('Event'),q=b('FullScreen'),r=b('ImageUtils'),s=b('Keys'),t=b('LinkController'),u=b('Locale'),v=b('PageTransitions'),w=b('Parent'),x=b('PhotosConst'),y=b('PhotoSessionLog'),z=b('PhotoSnowliftAds'),aa=b('PhotoStreamCache'),ba=b('PhotosUtils'),ca=b('PhotoViewer'),da=b('Rect'),ea=b('ScrollableArea'),fa=b('Style'),ga=b('Toggler'),ha=b('UIPagelet'),ia=b('URI'),ja=b('UserAgent'),ka=b('Vector'),la=b('$'),ma=b('computeRelativeURI'),na=b('copyProperties'),oa=b('createArrayFrom'),pa=b('csx'),qa=b('emptyFunction'),ra=b('ge'),sa=b('goURI'),ta=b('shield'),ua=b('tx'),va=b('userAction');function wa(){this.parent.construct(this);}na(wa,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_PIXELS:'image_pixels',STATE_IMAGE_DATA:'image',LOADING_TIMEOUT:2000,PAGER_FADE:3000,FULL_SCREEN_PADDING:10,STAGE_HIRES_MAX:{x:2048,y:2048},STAGE_NORMAL_MAX:{x:960,y:960},STAGE_MIN:{x:520,y:520},SIDEBAR_SIZE_MAX:360,STAGE_CHROME:{x:82,y:42},VIDEO_BOTTOM_BAR_SPACE:40,GOPREV_AREA:120,TIMELINE_STRETCH_WIDTH:843,TIMELINE_STRETCH_MIN:480,MIN_TAG_DISTANCE:83,PADDING_MIN:40,MIN_UFI_HEIGHT:250,_instance:null,getInstance:function(){if(!wa._instance)wa._instance=new wa();return wa._instance;},initWithSpotlight:function(xa,ya){wa.getInstance().init(xa,ya);},touch:qa,addPhotoFbids:function(xa,ya,za,ab){wa.getInstance().addPhotoFbids(xa,ya,za,ab);},attachFollowFlyout:function(xa){n.insertAfter(la('fbPhotoSnowliftSubscribe'),xa);},attachSubscribeFlyout:function(xa){n.insertAfter(la('fbPhotoSnowliftSubscribe'),xa);},attachTagger:function(xa){wa.getInstance().attachTagger(xa);},preload:function(xa,ya){wa.getInstance().preload(xa,ya);},bootstrap:function(xa,ya){if(xa&&ia(xa).getQueryData().hasOwnProperty('share_id')){j.loadModules(['SpotlightShareViewer'],function(za){za.bootstrap(xa,ya);});return;}wa.getInstance().bootstrap(xa,ya);},closeRefresh:function(){wa.getInstance().closeRefresh();},deletePhoto:function(xa){wa.getInstance().deletePhoto(xa);},getImage:function(){return wa.getInstance().getImage();},getImageId:function(){return wa.getInstance().getImageId();},getLoadQuery:function(){return wa.getInstance().getLoadQuery();},getRHCBody:function(){return wa.getInstance().getRHCBody();},getRHCFooter:function(){return wa.getInstance().getRHCFooter();},getRHCHeader:function(){return wa.getInstance().getRHCHeader();},getRoot:function(){return wa.getInstance().getRoot();},likePhotoSkipConfirmation:function(xa){wa.getInstance().likePhotoSkipConfirmation(xa);},saveTagsFromPayload:function(xa){wa.getInstance().saveTagsFromPayload(xa);},saveTagsFromPayloadDelayed:function(xa){wa.saveTagsFromPayload.curry(xa).defer(2000);},handleServerError:function(xa,ya){wa.getInstance().handleServerError(xa,ya);},setVideoWarning:function(xa,ya){var za=wa.getInstance(),ab='video_warning_'+xa;if(!za.videoWarnings)za.videoWarnings=[];za.videoWarnings[ab]=ya;},storeFromData:function(xa){wa.getInstance().storeFromData(xa);},swapData:function(){wa.getInstance().swapData();},touchMarkup:qa,updateTotalCount:function(xa,ya,za){wa.getInstance().updateTotalCount(xa,ya,za);}});k.extend(wa,ca);na(wa.prototype,{switchTimer:null,imageRefreshTimer:null,imageLoadingTimer:null,lastPage:0,currentMinSize:null,currentImageSize:null,resetUriStack:true,thumbSrc:null,shouldStretch:false,stageMax:wa.STAGE_NORMAL_MAX,stageChrome:wa.STAGE_CHROME,stagePagerPrev:null,ua:null,PhotoTagger:null,showHover:false,skipLikePhotoConfirmation:false,isShowingLikePhotoConfirmation:false,preload:function(xa,ya){j.loadModules(['PhotoTagger','fb-photos-snowlift-css','Live','PhotoTagApproval','PhotoTags','TagTokenizer','fb-photos-snowlift-fullscreen-css'],function(ab){this.PhotoTagger=ab;}.bind(this));var za=this.getImageSrc(ia(xa).getQueryData());if(za)(new Image()).src=za;},bootstrap:function(xa,ya){if(xa&&ia(xa).getQueryData().makeprofile){this.enableCropperOnInit=true;this.isUserProfilePic=ia(xa).getQueryData().makeuserprofile;this.isInProfilePicAlbum=ia(xa).getQueryData().inprofilepicalbum;}this.preload(xa,ya);if(this.closeDirty){this.bootstrap.bind(this,xa,ya).defer();return;}z.reset();this.resetUriStack=true;if(this.isOpen)if(this.openExplicitly){this.closeCleanup();this.resetUriStack=false;}else return;this.ua=va('snowlift',ya).uai('open');this.returningToStart=false;this.loading&&l.removeClass(this.loading,'loading');if(ya){l.addClass((this.loading=ya),'loading');if(this.container){var za=w.byClass(ya,'uiStreamStory');if(za){this.container.setAttribute('data-ownerid',za.id);}else this.container.removeAttribute('data-ownerid');}this.getThumbAndSize(ya);}else this.loading=null;g.inform('PhotoSnowlift.GO',xa,g.BEHAVIOR_STATE);this.loadFrameIfUninitialized();},getCurrentImageServerSizeDimensions:function(){return this.stream.getCurrentImageData().dimensions;},getEventPrefix:function(){return 'PhotoSnowlift';},getRoot:function(){return this.root;},getSourceString:function(){return 'snowlift';},getVersionConst:function(){return x.VIEWER_SNOWLIFT;},getImage:function(){return this.image;},getImageId:function(){return this.stream.getCursor();},getRHCHeader:function(){return this.rhcHeader;},getRHCBody:function(){return this.ufiForm;},getRHCFooter:function(){return this.rhcFooter;},getLoadQuery:function(){return this.loadQuery;},getCurrentPhotoInfo:function(){var xa=this.stream.getCurrentImageData();if(xa)return xa.info;return null;},getOwnerId:function(){var xa=this.stream.getCurrentImageData();if(xa)return xa.info.owner;return null;},getThumbAndSize:function(xa){this.currentImageSize=null;this.thumbSrc=null;var ya=ia(xa.getAttribute('ajaxify')).getQueryData();if(!ya.size)return;var za=ka.deserialize(ya.size);if(!za.x||!za.y)return;this.currentImageSize=za;if(!l.hasClass(xa,'uiMediaThumb')&&!l.hasClass(xa,'uiPhotoThumb')&&!l.hasClass(xa,'uiScaledThumb'))return;if(xa.getAttribute('data-cropped'))return;var ab=n.scry(xa,'img')[0],bb=n.scry(xa,'i')[0],cb=w.byAttribute(xa,'data-size');this.shouldStretch=cb&&this.currentImageSize&&ab&&cb.getAttribute('data-size')==="2"&&this.currentImageSize.x>this.currentImageSize.y&&this.currentImageSize.x<=wa.TIMELINE_STRETCH_WIDTH&&ab.offsetWidth===wa.TIMELINE_STRETCH_WIDTH;var db;if(ab){db=ab.src;}else if(bb){db=fa.get(bb,'backgroundImage').replace(/.*url\("?([^"]*)"?\).*/,'$1');}else return;this.thumbSrc=db;},loadFrameIfUninitialized:function(){if(this.root)return;new i('/ajax/photos/snowlift/init.php').setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();},init:function(xa,ya){this.init=qa;this.showHover=ya.pivot_hover;y.setEndMetrics(ya.pivot_end_metric);this.showEndPivot=ya.pivot_end;this.enableSnowliftProfilePicCropper=ya.snowlift_profile_pic_cropper;this.pagersOnKeyboardNav=ya.pagers_on_keyboard_nav;this.fullscreen=q.isSupported();this.showOGVideos=ya.og_videos;this.stageMax=wa.STAGE_HIRES_MAX;this.spotlight=xa;this.spotlight.subscribe('blur',function(){this.closingAction=y.OUTSIDE;}.bind(this));this.spotlight.subscribe('hide',ta(this.closeHandler,this));this.spotlight.subscribe('key',this.keyHandler.bind(this));this.initializeNodes(this.spotlight.getRoot());z.init(this.sideAdUnit,this,ya);if(!this.subscription){t.registerHandler(this.handleNavigateAway.bind(this));this.subscription=g.subscribe('PhotoSnowlift.GO',function(za,ab){this.openExplicitly=true;this.loading&&l.removeClass(this.loading,'loading');this.open(ab);}.bind(this));}this.transitionHandlerRegistered=false;this.returningToStart=false;v.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));if(this.fullscreen)q.subscribe('changed',this.onFullScreenChange.bind(this));},onFullScreenChange:function(){var xa=q.isFullScreen();l.conditionClass(document.body,'fbPhotoSnowliftFullScreenMode',xa);if(xa){if(!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))this.collapseRHC();var ya=this.stream.getCurrentImageData();if(ya&&ya.url&&this.image.src!==ya.url&&this.shouldShowHiRes(ya))this.switchImage(ya.url);this.adjustForResize();}else{this.uncollapseRHC();if(ja.chrome()&&!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))this.page(0,false);g.inform('reflow');}ga.hide();if(this.cropper)this.cropper.resetPhoto();},initializeNodes:function(xa){this.root=xa;this.container=n.find(xa,'div.fbPhotoSnowliftContainer');this.snowliftPopup=n.find(this.container,'div.fbPhotoSnowliftPopup');this.rhc=n.find(this.snowliftPopup,'div.rhc');this.rhcHeader=n.find(this.rhc,'div.rhcHeader');this.rhcFooter=n.find(this.rhc,'div.rhcFooter');this.ufiForm=n.find(this.rhc,'form.fbPhotosSnowliftFeedbackForm');this.ufiInputContainer=n.find(this.rhc,'div.fbPhotosSnowboxFeedbackInput');this.scroller=n.find(this.ufiForm,'div.rhcScroller');this.scrollerBody=n.find(this.scroller,'div.uiScrollableAreaBody');this.stageWrapper=n.find(this.snowliftPopup,'div.stageWrapper');this.overlay=n.find(this.snowliftPopup,'div.snowliftOverlay');this.errorBox=n.find(this.stageWrapper,'div.stageError');this.image=n.find(this.stageWrapper,'img.spotlight');this.stage=n.find(this.stageWrapper,'div.stage');this.videoStage=n.find(this.stageWrapper,'div.videoStage');this.prevPager=n.find(this.snowliftPopup,'a.snowliftPager.prev');this.nextPager=n.find(this.snowliftPopup,'a.snowliftPager.next');this.stageActions=n.find(xa,'div.stageActions');this.buttonActions=n.find(this.stageActions,'div.fbPhotosPhotoButtons');this.productMetadata=n.scry(this.rhc,'div.fbPhotosSnowliftProductMetadata').pop();this.sideAdUnit=n.find(xa,"._24q");g.inform('Amoeba/instrumentMulti',[[this.container,'snowlift'],[this.rhc,'rhc'],[this.rhcHeader,'rhc_header'],[this.ufiForm,'ufi_form'],[this.ufiInputContainer,'ufi_input'],[this.prevPager,'prev_pager'],[this.nextPager,'next_pager'],[this.stageActions,'stage_actions'],[this.sideAdUnit,'side_ads']],g.BEHAVIOR_PERSISTENT);l.conditionClass(this.root,'fullScreenAvailable',this.fullscreen);},initializeScroller:function(){this.initializeScroller=qa;this.scrollableArea=ea.fromNative(this.scroller,{fade:true,persistent:true});var xa=function(event){var ya=p.$E(event).getTarget();if(n.contains(this.ufiInputContainer,ya)){var za=o.getInstance(ya);if(za){this.scrollableArea.scrollToBottom();var ab=za.subscribe('resize',function(){var cb=this.scrollableArea.isScrolledToBottom();this.adjustScroller();cb&&this.scrollableArea.scrollToBottom();}.bind(this)),bb=p.listen(ya,'blur',function(){za.unsubscribe(ab);bb.remove();});}}}.bind(this);g.subscribe('ufi/changed',function(ya,za){if(this.ufiForm===za.form)this.adjustScrollerIfNecessary();}.bind(this));g.subscribe('ufi/comment',function(ya,za){if(this.ufiForm===za.form)if(za.isranked){this.scrollableArea.scrollToTop();}else this.scrollableArea.scrollToBottom();}.bind(this));p.listen(this.rhc,'click',function(event){var ya=event.getTarget();if(w.byTag(ya,'a')||w.byTag(ya,'button')||n.isNodeOfType(ya,'input'))this.adjustScrollerIfNecessary();}.bind(this));g.subscribe(['reflow','CommentUFI.Pager'],function(){if(this.isOpen)this.adjustScroller();}.bind(this));p.listen(this.ufiForm,'focusin',xa);},openHandler:function(xa){if(this.isOpen||xa.getPath()!='/photo.php'||this.returningToStart||xa.getQueryData().closeTheater||xa.getQueryData().permPage||xa.getQueryData().makeprofile){this.openHandlerRegistered=false;return false;}this.open(xa);this._uriStack.push(ia(xa).getQualifiedURI().toString());v.transitionComplete(true);return true;},getImageSrc:function(xa){if(xa.smallsrc){if(!xa.size)return xa.smallsrc;var ya=ka.deserialize(xa.size),za=this.getStageSize(ya);if(za.x<=wa.STAGE_NORMAL_MAX.x&&za.y<=wa.STAGE_NORMAL_MAX.y)return xa.smallsrc;}return xa.src;},open:function(xa){var ya=ia(xa).getQueryData(),za=this.getImageSrc(ya);if(za){delete ya.src;delete ya.smallsrc;}if(this.resetUriStack)this._uriStack=[];if(!this.initialLoad){ya.firstLoad=true;this.initialLoad=true;}this.sessionID=Date.now();this.sessionPhotosHilited={};this.loadQuery=na(ya,{ssid:this.sessionID});this.isOpen=true;this.pagersShown=false;this.refreshOnClose=false;this.hilitedTag=null;this.loadingStates={image:false,html:false};this.replaceUrl=false;this.stream=new aa();this.stream.init(x.VIEWER_SNOWLIFT,'PhotoViewerPagelet');this.fetchInitialData();this.setLoadingState(wa.STATE_HTML,true);this.rhcCollapsed=false;j.loadModules(['fb-photos-snowlift-css'],this._open.bind(this,xa,za));if(this.showEndPivot)j.loadModules(['PhotoPivot'],function(ab){this.pivots=ab.getInstance();if(ya.relevant_count)this.pivots.setRelevantCount(ya.relevant_count);}.bind(this));if(this.enableSnowliftProfilePicCropper)j.loadModules(['SnowliftPicCropper'],function(ab){this.cropper=ab.getInstance(this);this.cropper.init();if(this.enableCropperOnInit){var bb=g.subscribe('PhotoSnowlift.SWITCH_IMAGE',function(){if(this.isInProfilePicAlbum){this.cropper.showPicInProfileAlbumDialog();}else this.cropper.enableCropping(this.isUserProfilePic);g.unsubscribe(bb);}.bind(this));this.enableCropperOnInit=false;}}.bind(this));j.loadModules(['PhotosButtonTooltips'],function(ab){ab.init();});},_open:function(xa,ya){this.createLoader(ya);this.spotlight.show();this.ua&&this.ua.add_event('frame');g.inform('layer_shown',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.OPEN');this.stageHandlers=[p.listen(window,'resize',this.adjustForResize.bind(this)),p.listen(this.stageWrapper,'click',this.buttonListener.bind(this)),p.listen(this.stageWrapper,'mouseleave',function(event){this.hidePagers();}.bind(this)),p.listen(this.stageWrapper,'mousemove',this.hilitePagerOnMouseMove.bind(this)),p.listen(this.stageWrapper,'mousemove',this.hiliteTagsOnMouseMove.bind(this)),p.listen(this.overlay,'mouseenter',this.unhiliteAllTags.bind(this))];this.stageHandlers.push(p.listen(this.container,'click',function(event){var bb=event.getTarget();if(w.byClass(bb,'rotateRight')){this.rotate('right');}else if(w.byClass(bb,'rotateLeft')){this.rotate('left');}else if(w.byClass(bb,'closeTheater')){if(q.isFullScreen()){q.toggleFullScreen();return;}this.closingAction=y.X;this.closeHandler();return false;}else if(this.fullscreen)if(w.byClass(bb,'fbPhotoSnowliftFullScreen')){this.toggleFullScreen();}else if(w.byClass(bb,'fbPhotoSnowliftCollapse'))this.toggleCollapse();}.bind(this)));var za=ra('fbPhotoSnowliftFeedback');if(za)this.stageHandlers.push(p.listen(za,'click',function(event){var bb=event.getTarget();if(w.byClass(bb,'like_link')||(w.byClass(bb,'UFILikeLink')&&w.byClass(bb,'UIActionLinks')))this.toggleLikeButton();var cb=w.byClass(event.getTarget(),'uiUfiCollapsedComment');if(cb)l.addClass(cb,'uiUfiCollapsedCommentToggle');}.bind(this)));var ab=ra('fbPhotoSnowliftOnProfile');if(ab)this.stageHandlers.push(p.listen(ab,'click',function(event){if(w.byClass(event.getTarget(),'fbPhotoRemoveFromProfileLink'))this.refreshOnClose=true;}.bind(this)));if(this.resetUriStack)this.startingURI=ia.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI();if(!ya)this.setLoadingState(wa.STATE_IMAGE_DATA,true);if(!this.transitionHandlerRegistered){v.registerHandler(this.transitionHandler.bind(this));this.transitionHandlerRegistered=true;}y.initLogging(y.SNOWLIFT);if(this.pivots)y.setRelevantCount(this.pivots.relevantCount);},toggleFullScreen:function(){var xa=q.toggleFullScreen(document.documentElement);if(xa){var ya=this.stream.getCurrentImageData();if(ya&&ya.url&&this.image.src!==ya.url&&this.shouldShowHiRes(ya))(new Image()).src=ya.url;y.logEnterFullScreen(this.stream.getCursor());}},getStream:function(){return this.stream;},fetchInitialData:function(){this.ua&&this.ua.add_event('init_data');this.stream.waitForInitData();ha.loadFromEndpoint('PhotoViewerInitPagelet',null,this.loadQuery,{usePipe:true,jsNonblock:true,crossPage:true});},toggleCollapse:function(){if(this.rhcCollapsed){this.uncollapseRHC();}else this.collapseRHC();},collapseRHC:function(){this.rhcCollapsed=true;l.addClass(this.root,'collapseRHC');this.adjustForResize();},uncollapseRHC:function(){this.rhcCollapsed=false;l.removeClass(this.root,'collapseRHC');this.adjustForResize();},closeHandler:function(){if(!this.isOpen)return;this.closingAction=this.closingAction||y.ESC;if(ia.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI().toString()==this.startingURI.toString()){this.close();return;}this.returnToStartingURI(this.refreshOnClose);this.close();},returnToStartingURI:function(xa,ya){if(!xa)if(ya){this.squashNextTransition(sa.curry(ya));}else this.squashNextTransition();this.returningToStart=true;var za=g.subscribe('page_transition',(function(){this.returningToStart=false;za.unsubscribe();}).bind(this)),ab=xa||isNaN(ja.opera()),bb=this._uriStack.length;if(ab&&bb<window.history.length){window.history.go(-bb);}else{var cb=this.startingURI,db=new ia(cb).removeQueryData('closeTheater');if(cb.getQueryData().sk=='approve'&&cb.getPath()=='/profile.php'){db.removeQueryData('highlight');db.removeQueryData('notif_t');}sa(db);}},squashNextTransition:function(xa){this.squashNext=true;v.registerHandler(function ya(){if(this.squashNext){this.squashNext=false;if(xa)xa.defer();v.transitionComplete(true);return true;}return false;}.bind(this),7);},handleNavigateAway:function(xa){var ya=ma(v._most_recent_uri.getQualifiedURI(),xa.getAttribute('href'));if(this.isOpen&&(ya instanceof ia)&&ya.getUnqualifiedURI().toString()!=this.startingURI.toString()&&ya.getPath()!='/photo.php'){if(!this.closingAction)this.closingAction=y.NAVIGATE;this.returnToStartingURI(false,ya);this.close();return false;}return true;},close:function(){if(!this.isOpen)return;this.isOpen=false;if(this.fullscreen)q.disableFullScreen();va('snowlift').uai('close');this.cropper&&this.cropper.disableCropping();this.spotlight.hide();this.openExplicitly=false;this.closeDirty=true;this.closeCleanup.bind(this).defer();},closeCleanup:function(){this.closeDirty=false;l.removeClass(this.root,'dataLoading');y.logPhotoViews(this.closingAction);this.destroy();l.hide(this.errorBox);l.hide(this.image);this.currentImageSize=null;this.thumbSrc=null;this.shouldStretch=false;this.resetUriStack=true;l.removeClass(this.stageWrapper,'showVideo');n.empty(this.videoStage);this.uncollapseRHC();this.currentMinSize=null;this.rhcMinHeight=null;this.setStagePagersState('reset');this.recacheData();n.empty(this.sideAdUnit);this.stream.destroy();var xa=this.closingAction===y.NAVIGATE;this.closingAction=null;if(!this.openHandlerRegistered){v.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;}g.inform('layer_hidden',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.CLOSE',xa);this.root.setAttribute('aria-busy','true');},createLoader:function(xa){if(this.currentImageSize===null){this.adjustStageSize(wa.STAGE_MIN);}else{var ya=this.getStageSize(this.currentImageSize);ya=new ka(Math.max(ya.x,wa.STAGE_MIN.x),Math.max(ya.y,wa.STAGE_MIN.y));var za=this.getImageSizeInStage(this.currentImageSize,ya);if(this.thumbSrc===null){this.adjustStageSize(za);}else this.useImage(n.create('img',{className:'spotlight',alt:'',src:this.thumbSrc,style:{width:za.x+'px',height:za.y+'px'}}),za,false);}this.setLoadingState(this.STATE_IMAGE_PIXELS,true);if(xa)(function(){var ab=new Image();ab.onload=a.async_callback(function(){if(!this.isOpen||this.pendingImageUrl!=xa)return;if(!this.stream||!this.stream.errorInCurrent()){this.switchImage(xa,this.currentImageSize);this.ua&&this.ua.add_event('image');this.setLoadingState(wa.STATE_IMAGE_DATA,false);}}.bind(this),'photo_theater');ab.src=this.pendingImageUrl=xa;}).bind(this).defer();l.hide(this.stageActions);this.setStagePagersState('disabled');},initDataFetched:function(xa){y.setPhotoSet(this.stream.getPhotoSet());y.setLogFbids(xa.logids);var ya=this.stream.getCurrentImageData();y.addPhotoView(ya.info,this.shouldShowHiRes(ya),this.fullscreen&&q.isFullScreen());if(!this.pageHandlers)this.pageHandlers=[p.listen(this.root,'click',this.pageListener.bind(this)),p.listen(this.root,'mouseleave',this.mouseLeaveListener.bind(this))];l.show(this.stageActions);this.root.setAttribute('aria-busy','false');this.isLoggedInViewer=xa.loggedin;this.disableAdsForSession=xa.disablesessionads||!this.isLoggedInViewer;this.showFlashTags=!!xa.flashtags;this.disableAds=this.disableAdsForSession||xa.fromad;this.loadAds();},adjustScrollerIfNecessary:function(){clearTimeout(this.scrollerTimeout);this.scrollerTimeout=this.adjustScroller.bind(this).defer();},adjustScroller:function(){clearTimeout(this.scrollerTimeout);this.initializeScroller();this.scrollableArea.resize();var xa=ka.getElementDimensions(this.rhc),ya=xa.y;ya-=ka.getElementDimensions(this.rhcHeader).y;ya-=ka.getElementDimensions(this.ufiInputContainer).y;if(this.productMetadata)ya-=ka.getElementDimensions(this.productMetadata).y;this.rhcMinHeight=xa.y-(ya-wa.MIN_UFI_HEIGHT);ya=Math.max(0,ya);var za=ka.getElementDimensions(this.scrollerBody).y;if(za>=ya){fa.set(this.scroller,'height',ya+'px');l.addClass(this.rhc,'pinnedUfi');ya=0;}else{fa.set(this.scroller,'height','auto');l.removeClass(this.rhc,'pinnedUfi');ya-=za;}var ab=ka.getElementDimensions(this.ufiInputContainer).y;fa.set(this.ufiForm,'padding-bottom',ab+'px');z.resize(new ka(xa.x,ya));this.scrollableArea.adjustGripper();},adjustForResize:function(){this.currentMinSize=null;this.adjustStageSize();this.adjustForNewData();},shouldShowHiRes:function(xa){if(!xa||!xa.smallurl)return false;var ya=this.getStageSize(xa.dimensions),za=this.getImageSizeInStage(xa.dimensions,ya);return (za.x>wa.STAGE_NORMAL_MAX.x||za.y>wa.STAGE_NORMAL_MAX.y);},getImageURL:function(xa){if(xa.video){return null;}else if(xa.smallurl&&!this.shouldShowHiRes(xa))return xa.smallurl;return xa.url;},getImageDimensions:function(xa){if(xa.smalldims&&(!this.shouldShowHiRes(xa)||this.image.src===xa.smallurl))return xa.smalldims;return xa.dimensions;},getStageSize:function(xa,ya){var za=ka.getViewportDimensions(),ab=new ka(xa.x,xa.y);if(ya)ab=new ka(Math.max(xa.x,ya.x),Math.max(xa.y,ya.y));var bb,cb;if(this.fullscreen&&q.isFullScreen()){return new ka((this.rhcCollapsed?screen.width:screen.width-wa.SIDEBAR_SIZE_MAX),screen.height-wa.FULL_SCREEN_PADDING*2);}else{bb=Math.min(ab.x,this.stageMax.x,(za.x-wa.SIDEBAR_SIZE_MAX-wa.STAGE_CHROME.x));cb=Math.min(ab.y,this.stageMax.y,za.y-wa.STAGE_CHROME.y);}if(bb===0&&cb===0)return new ka(0,0);var db=bb/cb,eb=ab.x/ab.y;if(db<eb)return new ka(bb,Math.round(bb/eb));return new ka(Math.round(cb*eb),cb);},getImageSizeInStage:function(xa,ya){var za=xa.x,ab=xa.y;if(za>=ya.x||ab>=ya.y){var bb=ya.x/ya.y,cb=za/ab;if(bb<cb){za=ya.x;ab=Math.round(za/cb);}else if(bb>cb){ab=ya.y;za=Math.round(ab*cb);}else{za=ya.x;ab=ya.y;}}return new ka(za,ab);},adjustStageSize:function(xa){var ya=this.currentImageSize;if(xa){ya=xa;}else{var za=this.stream&&this.stream.getCurrentImageData();if(za)ya=this.getImageDimensions(za);}if(!ya)return;this.currentImageSize=ya;var ab=0;if(this.shouldStretch&&!this.getVideoOnStage()&&ya.x>ya.y&&ya.x<=wa.TIMELINE_STRETCH_WIDTH&&ya.x>=wa.TIMELINE_STRETCH_MIN){ya.y=Math.round(ya.y*wa.TIMELINE_STRETCH_WIDTH/ya.x);ya.x=wa.TIMELINE_STRETCH_WIDTH;}else if(this.getVideoOnStage()){ab=wa.VIDEO_BOTTOM_BAR_SPACE*2;ya.y+=ab;}var bb=this.getStageSize(ya,this.currentMinSize);if(!this.currentMinSize)this.currentMinSize=new ka(0,0);if(!this.rhcMinHeight)this.rhcMinHeight=0;this.currentMinSize=new ka(Math.max(bb.x,wa.STAGE_MIN.x,this.currentMinSize.x),Math.max(bb.y,wa.STAGE_MIN.y,this.currentMinSize.y));var cb=this.getImageSizeInStage(ya,this.currentMinSize),db=this.currentMinSize.x-cb.x,eb=this.currentMinSize.y-cb.y;if(db>0&&db<wa.PADDING_MIN){this.currentMinSize.x-=db;}else if(eb>0&&eb<wa.PADDING_MIN)this.currentMinSize.y-=eb;var fb=n.scry(this.productMetadata,'#fbPhotoSnowliftTaggedProducts .taggee');if(fb.length)this.currentMinSize.y=Math.max(this.currentMinSize.y,this.rhcMinHeight);var gb=this.currentMinSize.x+wa.SIDEBAR_SIZE_MAX;if(this.rhcCollapsed)gb=this.currentMinSize.x;this.snowliftPopup.style.cssText='width:'+gb+'px;'+'height:'+this.currentMinSize.y+'px;';var hb=this.currentMinSize.y-ab+'px';if(ja.firefox()||ja.ie()<8){var ib=fa.get(this.stageWrapper,'font-size');if(ja.ie()&&ib.indexOf('px')<0){var jb=n.create('div');jb.style.fontSize=ib;jb.style.height='1em';ib=jb.style.pixelHeight;}hb=((this.currentMinSize.y-ab)/parseFloat(ib))+'em';}this.stageWrapper.style.cssText='width:'+this.currentMinSize.x+'px;'+'line-height:'+hb+';';if(ja.ie()<8){fa.set(this.root,'height',ka.getViewportDimensions().y+'px');fa.set(this.container,'min-height',(this.currentMinSize.y+wa.STAGE_CHROME.y)+'px');}this.image.style.cssText='width:'+cb.x+'px;'+'height:'+cb.y+'px;';var kb=this.getTagger();if(kb)kb.repositionTagger();this.adjustScrollerIfNecessary();},adjustForNewData:function(){if(!this.image)return;var xa=n.scry(this.stage,'div.tagsWrapper')[0],ya=ka.getElementDimensions(this.image);if(xa){fa.set(xa,'width',ya.x+'px');fa.set(xa,'height',ya.y+'px');if(ja.ie()<=7){var za=n.scry(this.root,'div.tagContainer')[0];if(za)l.conditionClass(xa,'ie7VerticalFix',ka.getElementDimensions(za).y>ya.y);}}},setLoadingState:function(xa,ya){switch(xa){case wa.STATE_IMAGE_PIXELS:l.conditionClass(this.root,'imagePixelsLoading',ya);break;case wa.STATE_IMAGE_DATA:this.loadingStates[xa]=ya;l.conditionClass(this.root,'imageLoading',ya);break;case wa.STATE_HTML:this.loadingStates[xa]=ya;l.conditionClass(this.root,'dataLoading',ya);this.rhc.setAttribute('aria-busy',ya?'true':'false');break;}},destroy:function(){this.stageHandlers.forEach(function(xa){xa.remove();});if(this.pageHandlers){this.pageHandlers.forEach(function(xa){xa.remove();});this.pageHandlers=null;}},checkState:function(xa){if(xa!=wa.STATE_ERROR&&!this.loadingStates[xa])return;switch(xa){case wa.STATE_IMAGE_DATA:var ya=this.stream.getCurrentImageData();if(ya){var za=this.getImageURL(ya);if(za){this.switchImage(za,null,true);}else if(ya.video)this.switchVideo(ya.video,true);this.setLoadingState(xa,false);}break;case wa.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.showPagers(wa.PAGER_FADE);this.setLoadingState(xa,false);}break;default:if(this.stream.errorInCurrent()){l.hide(this.image);l.show(this.errorBox);}break;}},buttonListener:function(event){var xa=event.getTarget(),ya=Date.now();if(w.byClass(xa,'fbPhotoTagApprovalBox'))return;if(w.byClass(xa,'fbPhotosCornerWantButton')){event.stop();return;}if(ya-this.lastPage<350)return;if(w.byClass(xa,'fbPhotosPhotoLike')){this.likePhoto();}else if(w.byClass(xa,'tagApproveIgnore'))this.updateTagBox(event,xa);},likePhoto:function(){y.addButtonLike();var xa=la('fbPhotoSnowliftFeedback'),ya=n.scry(xa,'button.like_link')[0];if(!ya)ya=n.scry(xa,'a.UFILikeLink')[0];var za=ya.getAttribute('href');if(q.isFullScreen())if(ja.chrome())ya.setAttribute('href','javascript:;');ya.click();ya.setAttribute('href',za);},toggleLikeButton:function(){var xa=n.scry(this.buttonActions,'a.fbPhotosPhotoLike')[0];if(xa){var ya=n.find(this.root,'.likeCount'),za=n.find(ya,'.likeCountNum');if(ya)if(l.hasClass(xa,'viewerLikesThis')){n.setContent(za,parseInt(za.textContent,10)-1);}else n.setContent(za,parseInt(za.textContent,10)+1);l.toggleClass(xa,'viewerLikesThis');l.removeClass(xa,'viewerAlreadyLikedThis');}},likePhotoWithKey:function(){if(this.isShowingLikePhotoConfirmation)return;if(this.skipLikePhotoConfirmation){this.likePhoto();}else h.send(new i('/photos/confirm_like.php'),function(xa){this.isShowingLikePhotoConfirmation=true;xa.subscribe('confirm',this.onCloseLikePhotoConfirmDialog.bind(this));xa.subscribe('cancel',this.onCloseLikePhotoConfirmDialog.bind(this));}.bind(this));return false;},likePhotoSkipConfirmation:function(xa){this.skipLikePhotoConfirmation=xa;this.likePhoto();},onCloseLikePhotoConfirmDialog:function(){this.isShowingLikePhotoConfirmation=false;},updateTagBox:function(xa,ya){this.unhiliteAllTags();var za=ra(xa);if(!za)return;l.addClass(za,'tagBox');l.addClass(za,'tagBoxPendingResponse');l.removeClass(za,'tagBoxPending');l.hide(n.find(za,'span.tagForm'));if(ya){l.show(n.find(za,'span.tagApproved'));}else l.show(n.find(za,'span.tagIgnored'));},rotate:function(xa){var ya=this.stream.getCursor();if(this.getVideoOnStage()){var za=(xa=='left')?270:90;j.loadModules(['VideoRotate'],function(bb){new bb(ya).motionRotate(za);});return;}var ab=na({fbid:ya,cs_ver:x.VIEWER_SNOWLIFT},this.stream.getPhotoSetQuery());ab[xa]=1;this.setLoadingState(wa.STATE_IMAGE_DATA,true);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);l.hide(this.image);new i('/ajax/photos/photo/rotate/').setAllowCrossPageTransition(true).setData(ab).setErrorHandler(this.rotationError.bind(this,ya)).setFinallyHandler(this.rotationComplete.bind(this,ya)).setMethod('POST').setReadOnly(false).send();},rotationComplete:function(xa,ya){if(xa==this.stream.getCursor()){this.setLoadingState(wa.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));this.swapData();}},rotationError:function(xa,ya){if(xa==this.stream.getCursor()){this.setLoadingState(wa.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));j.loadModules(['AsyncResponse'],function(za){za.defaultErrorHandler(ya);});}},saveTagsFromPayload:function(xa){this.storeFromData(xa);if('data' in xa&&this.stream.getCursor() in xa.data)this.swapData();},saveEdit:function(){if(!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))return;j.loadModules(['PhotoInlineEditor','Form'],function(xa,ya){var za=xa.getInstance(this.getViewerConst());za&&ya.bootstrap(za.getForm().controller);}.bind(this));},mouseLeaveListener:function(event){this.unhiliteAllTags();this.reHilitePendingTag();},hilitePagerOnMouseMove:function(event){var xa=ka.getEventPosition(event),ya=ka.getElementPosition(this.stage);if(u.isRTL()){var za=ka.getElementDimensions(this.stage);this.stagePagerPrev=za.x-(xa.x-ya.x)<wa.GOPREV_AREA;}else this.stagePagerPrev=xa.x-ya.x<wa.GOPREV_AREA;l.conditionClass(this.prevPager,'hilightPager',this.stagePagerPrev);l.conditionClass(this.nextPager,'hilightPager',!this.stagePagerPrev);var ab,bb=event.getTarget();if(!w.byClass(bb,'snowliftOverlay')&&!w.byClass(bb,'bottomBarActions')&&!w.byClass(bb,'snowliftPager'))ab=wa.PAGER_FADE;this.showPagers(ab);},showPagers:function(xa){clearTimeout(this.fadePagerTimer);this.setStagePagersState('active');if(typeof xa!=='undefined')this.fadePagerTimer=this.hidePagers.bind(this).defer(xa);},hidePagers:function(){var xa=n.scry(this.getRoot(),'.fbPhotosPhotoActionsMenu')[0];if(xa)return;clearTimeout(this.fadePagerTimer);this.setStagePagersState('inactive');},getTagger:function(){if(!this.PhotoTagger)return null;var xa=this.PhotoTagger.getInstance(x.VIEWER_SNOWLIFT);if(!xa||!xa.tagHoverFacebox)return null;return xa;},hiliteAllTags:function(){var xa=this.stream.getCurrentImageData().info.fbid;if(this.sessionPhotosHilited[xa])return;n.scry(this.stage,'div.tagsWrapper div.tagBox').forEach(function(ya){l.addClass(ya,'hover');});this.sessionPhotosHilited[xa]=true;this.unhiliteTimer=this.unhiliteAllTags.bind(this).defer(2000,true);},unhiliteAllTags:function(){clearTimeout(this.unhiliteTimer);n.scry(this.stage,'div.tagsWrapper div.hover').forEach(function(ya){l.removeClass(ya,'hover');});this.hilitedTag=null;if(!l.hasClass(this.root,'taggingMode')){var xa=this.getTagger();if(xa){xa.hideTagger();xa.setCurrentFacebox(null);}}},switchHilitedTags:function(xa,ya){if(this.switchTimer!==null){clearTimeout(this.switchTimer);this.switchTimer=null;}this.unhiliteAllTags();var za=ra(xa);if(za){this.hilitedTag=xa;if(!l.hasClass(this.root,'taggingMode')&&ba.isFacebox(this.hilitedTag)){var ab=this.getTagger();if(ab){l.addClass(za,'hover');var bb=ab.getFacebox(xa);ab.setCurrentFacebox(bb);if(bb)ab.addTagFromFacebox(bb);}}else l.addClass(za,'hover');if(l.hasClass(za,'tagBoxPending')&&!l.hasClass(za,'showPendingTagName')&&ya===true){n.scry(this.stage,'div.tagsWrapper div.showPendingTagName').forEach(function(cb){l.removeClass(cb,'showPendingTagName');});l.addClass(za,'showPendingTagName');}}},reHilitePendingTag:function(){var xa=ra(this.hilitedTag);if(xa&&l.hasClass(xa,'showPendingTagName'))return;var ya=n.scry(this.stage,'div.tagsWrapper div.showPendingTagName')[0];if(ya)this.switchHilitedTags(ya.id);},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.switchTimer!==null)return;var xa=event.getTarget();if(w.byClass(xa,'snowliftOverlay')||w.byClass(xa,'fbPhotoSnowliftTagApproval')||w.byClass(xa,'tagPointer')||w.byClass(xa,'photoTagTypeahead'))return;var ya=w.byClass(xa,'tagBoxPending'),za=false;if(this.hilitedTag){var ab=ra(this.hilitedTag);za=ab&&l.hasClass(ab,'tagBoxPending');}var bb=((!this.hilitedTag&&ya)||(!za&&ya));if(bb){this.switchHilitedTags(ya.id);return;}if(ya&&(ya.id==this.hilitedTag))return;var cb=250,db=ba.absoluteToNormalizedPosition(this.image,ka.getEventPosition(event));if(this.currentTagHasPrecedence(db))return;var eb=ba.getNearestBox(this.stream.getCurrentExtraData().tagRects,db);if(!eb){if(!za){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var fb=null;if(za){var gb={};gb[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];fb=ba.getNearestBox(gb,db);}if(fb!==null&&za)return;if(this.hilitedTag!=eb)if(za){this.switchTimer=this.switchHilitedTags.bind(this,eb).defer(cb);}else{if(this.showHover){if(!this.seenTags)this.seenTags=[];if(!this.seenTags[eb]){y.addFaceTagImpression();this.seenTags[eb]=true;}}this.switchHilitedTags(eb);}},currentTagHasPrecedence:function(xa){if(!this.hilitedTag)return false;var ya=this.stream.getCurrentExtraData().tagRects[this.hilitedTag],za=new da(ya.t+(ya.h()/2),ya.r,ya.b+(ba.isFacebox(this.hilitedTag)?10:0),ya.l,ya.domain);return za.contains(xa);},getVideoOnStage:function(){var xa=this.stream&&this.stream.getCurrentImageData();return xa&&xa.video;},shouldPageOnAction:function(xa,ya){if(!this.isOpen||this.isShowingLikePhotoConfirmation)return false;var za=n.isNode(ya)&&(w.byClass(ya,'snowliftPager')||w.byClass(ya,'stagePagers')||w.byClass(ya,'pivotPageColumn')),ab=n.isNode(ya)&&w.byClass(ya,'stage'),bb=l.hasClass(ya,'faceBox'),cb=((ab&&l.hasClass(this.root,'taggingMode'))||w.byClass(ya,'tagBoxPending')||w.byClass(ya,'tagBoxPendingResponse')||w.byClass(ya,'fbPhotoTagApprovalBox')||w.byClass(ya,'tag')||(this.cropper&&this.cropper.croppingMode));if(cb)return false;return xa==s.LEFT||xa==s.RIGHT||(!l.hasClass(this.root,'taggingMode')&&bb)||za||ab;},keyHandler:function(xa,event){if(event.getModifiers().any)return true;switch(p.getKeyCode(event)){case s.LEFT:case s.RIGHT:if(!this.pagersOnKeyboardNav)this.showPagers(wa.PAGER_FADE);this.pageListener(event);return false;case 70:return this.toggleFullScreen();case 76:return this.likePhotoWithKey();}},pageListener:function(event){var xa=p.getKeyCode(event),ya=event.getTarget();if(!this.shouldPageOnAction(xa,ya))return;var za=0;if(xa==s.RIGHT){za=1;y.setPagingAction('key_right');}else if(xa==s.LEFT){za=-1;y.setPagingAction('key_left');}else if(w.byClass(ya,'next')){za=1;y.setPagingAction('click_next');}else if(w.byClass(ya,'prev')){za=-1;y.setPagingAction('click_prev');}else if(!this.stagePagerPrev){za=1;y.setPagingAction('click_stage');}else{za=-1;y.setPagingAction('click_stage_back');}if(l.hasClass(this.root,'fbPhotoSnowliftEditMode')||(this.cropper&&this.cropper.croppingMode)){this.warnLeavePage(za);}else{this.page(za,ja.chrome()&&q.isFullScreen());va('snowlift',ya,event).uai(y.pagingAction);}},warnLeavePage:function(xa){new m().setTitle("Are you sure you want to leave this page?").setBody("You have unsaved changes that will be lost if you leave the page.").setButtons([{name:'leave_page',label:"Leave this Page",handler:this.page.bind(this,xa)},{name:'continue_editing',label:"Stay on this Page",className:'inputaux'}]).setModal(true).show();},page:function(xa,ya){if(!this.stream.isValidMovement(xa)){this.showPagers(wa.PAGER_FADE);return;}this.lastPage=Date.now();this.unhiliteAllTags();this.seenTags=[];var za=this.getVideoOnStage();if(za)this.switchVideo(za,false);if(this.pivots&&this.pivots.page(xa))return;g.inform('PhotoSnowlift.PAGE');ga.hide();this.recacheData();this.stream.moveCursor(xa);l.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(wa.STATE_HTML,true);l.show(this.errorBox);return;}var ab=this.stream.getCurrentImageData();if(ab){var bb=this.getImageURL(ab);if(bb){this.switchImage(bb,null,true);}else if(ab.video)this.switchVideo(ab.video,true);if(!ya){this.replaceUrl=true;sa(ab.info.permalink);}this.setLoadingState(wa.STATE_IMAGE_DATA,false);}else{this.setLoadingState(wa.STATE_IMAGE_PIXELS,true);this.setLoadingState(wa.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(wa.STATE_HTML,true);this.disableAds=this.disableAdsForSession;this.loadAds();if(this.cropper)this.cropper.resetPhoto();},logImpressionDetailsForPhoto:function(){var xa=[].concat(n.scry(la('fbPhotoSnowliftTagList'),'input.photoImpressionDetails'),n.scry(la('fbPhotoSnowliftFeedback'),'input.photoImpressionDetails'));if(xa.length===0)return;var ya={};for(var za=0;za<xa.length;za++)ya[xa[za].name]=xa[za].value;if(this.getVideoOnStage()){ya.width=0;ya.height=0;}else{var ab=this.getImageDimensions(this.stream.getCurrentImageData());ya.width=ab.x;ya.height=ab.y;}y.addDetailData(this.stream.getCursor(),ya);z.setIsLogAdData(true);},loadAds:function(){if(this.disableAds)return;z.loadAdsFromUserActivity();},transitionHandler:function(xa){if(xa.getQueryData().closeTheater||xa.getQueryData().permPage||xa.getQueryData().makeprofile||this.returningToStart){if(this.isOpen)this.close();this.transitionHandlerRegistered=false;return false;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(xa.getQualifiedURI().toString());v.transitionComplete(true);return true;}var ya=this._uriStack.length;if(ya>=2&&this._uriStack[ya-2]==xa.getQualifiedURI().toString())this._uriStack.pop();var za=this.stream.getCursorForURI(xa.getUnqualifiedURI().toString());if(za){var ab=this.stream.getRelativeMovement(za);this.page(ab,true);v.transitionComplete(false);return true;}if(this.isOpen){v.transitionComplete(true);this.close();return true;}this.transitionHandlerRegistered=false;return false;},recacheData:function(){if(!this.loadingStates.html){var xa=this.stream.getCurrentHtml();for(var ya in xa){xa[ya]=oa(la(ya).childNodes);n.empty(la(ya));}}},reloadIfTimeout:function(){if(!r.hasLoaded(this.image)){var xa=this.makeNewImage(this.image.src,true);p.listen(xa,'load',this.useImage.bind(this,xa,null,true));}},useImage:function(xa,ya,za){if(za&&r.hasLoaded(this.image))return;n.replace(this.image,xa);this.image=xa;g.inform('Amoeba/instrument',[this.image,'image'],g.BEHAVIOR_PERSISTENT);this.adjustStageSize(ya);},makeNewImage:function(xa,ya){if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}else if(!ya)this.imageRefreshTimer=setTimeout(this.reloadIfTimeout.bind(this),wa.LOADING_TIMEOUT);var za=n.create('img',{className:'spotlight',alt:''});za.setAttribute('aria-describedby','fbPhotosSnowliftCaption');za.setAttribute('aria-busy','true');p.listen(za,'load',a.async_callback(function(){clearTimeout(this.imageRefreshTimer);this.image.setAttribute('aria-busy','false');this.setLoadingState(this.STATE_IMAGE_PIXELS,false);(function(){if(this.isOpen){this.adjustStageSize();this.adjustForNewData();}}).bind(this).defer();}.bind(this),'photo_theater'));za.src=xa;return za;},switchImage:function(xa,ya,za){l.hide(this.image);l.hide(this.errorBox);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);var ab=this.stream&&this.stream.getCurrentImageData();if(ab)y.addPhotoView(ab.info,this.shouldShowHiRes(ab),this.fullscreen&&q.isFullScreen());this.useImage(this.makeNewImage(xa,false),ya,false);if(za)this.stream.preloadImages(this.shouldShowHiRes(ab));if(this.cropper&&this.cropper.croppingMode)this.cropper.resetPhoto();g.inform('PhotoSnowlift.SWITCH_IMAGE');},switchVideo:function(xa,ya){var za='swf_'+xa;if(ya){l.addClass(this.stageWrapper,'showVideo');var ab=n.create('div',{className:'videoStageContainer'});n.appendContent(this.videoStage,ab);ab.id=xa;if(window[za]&&!ra(za))window[za].write(xa);var bb='video_warning_'+xa,cb=ra(xa);if(!this.videoWarnings)this.videoWarnings=[];if(cb&&this.videoWarnings[bb])n.setContent(cb,this.videoWarnings[bb]);this.adjustStageSizeForVideo.bind(this,za).defer();}else{window[za]&&window[za].addVariable('video_autoplay',0);this.videoLoadTimer&&clearTimeout(this.videoLoadTimer);n.empty(this.videoStage);l.removeClass(this.stageWrapper,'showVideo');}},checkVideoStatus:function(xa){if(this.videoLoadTimer)clearTimeout(this.videoLoadTimer);var ya=this.getVideoOnStage();if(!ya){return;}else{var za='swf_'+ya;if(xa!==za)return;this.adjustStageSizeForVideo(xa);}},adjustStageSizeForVideo:function(xa){var ya=ra(xa);if(!ya){this.videoLoadTimer=setTimeout(this.checkVideoStatus.bind(this,xa),200);}else this.adjustStageSize(new ka(ya.width,ya.height));},handleServerError:function(xa,ya){n.setContent(this.errorBox,xa);this.storeFromData(ya);},swapData:function(){var xa,ya=this.stream.getCurrentHtml();if(ya){this.setLoadingState(wa.STATE_HTML,false);for(var za in ya){xa=ra(za);xa&&n.setContent(xa,ya[za]);}g.inform('PhotoSnowlift.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData())g.inform('PhotoSnowlift.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);}this.adjustScroller();this.adjustStageSize();this.scrollableArea.showScrollbar(false);this.adjustForNewData();this.logImpressionDetailsForPhoto();if(this.showFlashTags)this.hiliteAllTags();},updateTotalCount:function(xa,ya,za){var ab=this.stream.getCurrentHtml();if(ab){var bb=la('fbPhotoSnowliftPositionAndCount');n.replace(bb,za);bb=za;l.show(bb);var cb='fbPhotoSnowliftPositionAndCount';ab[cb]=oa(bb.childNodes);}this.stream.setTotalCount(xa);this.stream.setFirstCursorIndex(ya);},addPhotoFbids:function(xa,ya,za,ab){if(ab&&this.sessionID&&ab!=this.sessionID)return;var bb=this.stream.getCursor()===null;this.stream.attachToFbidsList(xa,ya,za);if(za&&bb)this.page(0,true);if(this.pivots&&za)this.pivots.setCycleCount(this.stream.calculateDistance(this.stream.getCursor(),this.stream.firstCursor));if(!this.pagersShown&&this.stream.canPage())this.setStagePagersState('ready');},attachTagger:function(xa){n.appendContent(this.stageActions,xa);},storeFromData:function(xa){if(!this.isOpen)return;if(xa.ssid&&this.sessionID&&this.sessionID!=xa.ssid)return;var ya=this.stream.storeToCache(xa);if('error' in ya){this.checkState(wa.STATE_ERROR);return;}if('init' in ya){this.initDataFetched(ya.init);if(this.openExplicitly){this.replaceUrl=true;sa(this.stream.getCurrentImageData().info.permalink);}if(this.stream.canPage())this.setStagePagersState('ready');this.ua&&this.ua.add_event('ufi');}if('image' in ya)this.checkState(wa.STATE_IMAGE_DATA);if('data' in ya)this.checkState(wa.STATE_HTML);},setStagePagersState:function(xa){switch(xa){case 'ready':l.addClass(this.root,'pagingReady');this.pagersShown=true;this.ua&&this.ua.add_event('arrows');return;case 'active':l.addClass(this.root,'pagingActivated');return;case 'inactive':l.removeClass(this.root,'pagingActivated');return;case 'disabled':case 'reset':l.removeClass(this.root,'pagingReady');return;}},deletePhoto:function(xa){this.closeRefresh();},closeRefresh:function(){this.refreshOnClose=true;this.closeHandler();},onHiliteTag:function(xa,ya){if(ya.version!=x.VIEWER_SNOWLIFT)return;var za=ya.tag;if(za)this.switchHilitedTags(za,true);},onUpdateTagBox:function(xa,ya){if(ya.version==x.VIEWER_SNOWLIFT)this.updateTagBox(ya.id,ya.approve);}});e.exports=wa;});
__d("Spotlight",["JSXDOM","Arbiter","ArbiterMixin","Class","DOM","Layer","LayerAutoFocus","LayerTabIsolation","ModalLayer","Vector","copyProperties","csx","cx"],function(a,b,c,d,e,f){var g=b('JSXDOM'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('Class'),k=b('DOM'),l=b('Layer'),m=b('LayerAutoFocus'),n=b('LayerTabIsolation'),o=b('ModalLayer'),p=b('Vector'),q=b('copyProperties'),r=b('csx'),s=b('cx');function t(v,w){this.parent.construct(this,v,w);this.stageMinSize=new p(0,0);this.stagePadding=new p(0,0);}j.extend(t,l);q(t.prototype,i,{stageMinSize:null,stagePadding:null,_buildWrapper:function(v,w){return (g.div({className:"_n8 _3qx"},g.div({className:"_n9"},w)));},_getDefaultBehaviors:function(){return this.parent._getDefaultBehaviors().concat([u,m,n,o]);},getContentRoot:function(){if(!this._content)this._content=k.find(this.getRoot(),"div._n3");return this._content;},configure:function(v){if(v.stageMinSize)this.stageMinSize=v.stageMinSize;if(v.stagePadding)this.stagePadding=v.stagePadding;},onContentLoaded:function(){this.inform('content-load');},updatePermalink:function(v){this.inform('permalinkchange',v);}});function u(v){this._layer=v;}q(u.prototype,{_subscription:null,enable:function(){this._subscription=this._layer.subscribe(['show','hide'],function(v,w){if(v==='show'){h.inform('layer_shown',{type:'Spotlight'});}else h.inform('layer_hidden',{type:'Spotlight'});});},disable:function(){this._subscription.unsubscribe();this._subscription=null;}});e.exports=t;});